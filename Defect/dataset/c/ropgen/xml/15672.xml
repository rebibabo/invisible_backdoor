<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<unit xmlns="http://www.srcML.org/srcML/src" xmlns:pos="http://www.srcML.org/srcML/position" revision="1.0.0" language="C" filename="dataset/ropgen/aug/1/15672.c" pos:tabs="8"><function pos:start="1:1" pos:end="83:1"><type pos:start="1:1" pos:end="1:14"><specifier pos:start="1:1" pos:end="1:6">static</specifier> <name pos:start="1:8" pos:end="1:14">int64_t</name></type> <name pos:start="1:16" pos:end="1:26">alloc_block</name><parameter_list pos:start="1:27" pos:end="1:68">(<parameter pos:start="1:28" pos:end="1:47"><decl pos:start="1:28" pos:end="1:47"><type pos:start="1:28" pos:end="1:47"><name pos:start="1:28" pos:end="1:43">BlockDriverState</name><modifier pos:start="1:44" pos:end="1:44">*</modifier></type> <name pos:start="1:46" pos:end="1:47">bs</name></decl></parameter>, <parameter pos:start="1:50" pos:end="1:67"><decl pos:start="1:50" pos:end="1:67"><type pos:start="1:50" pos:end="1:67"><name pos:start="1:50" pos:end="1:56">int64_t</name></type> <name pos:start="1:58" pos:end="1:67">sector_num</name></decl></parameter>)</parameter_list>

<block pos:start="3:1" pos:end="83:1">{<block_content pos:start="5:5" pos:end="81:14">

    <decl_stmt pos:start="5:5" pos:end="5:33"><decl pos:start="5:5" pos:end="5:32"><type pos:start="5:5" pos:end="5:18"><name pos:start="5:5" pos:end="5:16">BDRVVPCState</name> <modifier pos:start="5:18" pos:end="5:18">*</modifier></type><name pos:start="5:19" pos:end="5:19">s</name> <init pos:start="5:21" pos:end="5:32">= <expr pos:start="5:23" pos:end="5:32"><name pos:start="5:23" pos:end="5:32"><name pos:start="5:23" pos:end="5:24">bs</name><operator pos:start="5:25" pos:end="5:26">-&gt;</operator><name pos:start="5:27" pos:end="5:32">opaque</name></name></expr></init></decl>;</decl_stmt>

    <decl_stmt pos:start="7:5" pos:end="7:23"><decl pos:start="7:5" pos:end="7:22"><type pos:start="7:5" pos:end="7:11"><name pos:start="7:5" pos:end="7:11">int64_t</name></type> <name pos:start="7:13" pos:end="7:22">bat_offset</name></decl>;</decl_stmt>

    <decl_stmt pos:start="9:5" pos:end="9:30"><decl pos:start="9:5" pos:end="9:18"><type pos:start="9:5" pos:end="9:12"><name pos:start="9:5" pos:end="9:12">uint32_t</name></type> <name pos:start="9:14" pos:end="9:18">index</name></decl>, <decl pos:start="9:21" pos:end="9:29"><type ref="prev" pos:start="9:5" pos:end="9:12"/><name pos:start="9:21" pos:end="9:29">bat_value</name></decl>;</decl_stmt>

    <decl_stmt pos:start="11:5" pos:end="11:12"><decl pos:start="11:5" pos:end="11:11"><type pos:start="11:5" pos:end="11:7"><name pos:start="11:5" pos:end="11:7">int</name></type> <name pos:start="11:9" pos:end="11:11">ret</name></decl>;</decl_stmt>

    <decl_stmt pos:start="13:5" pos:end="13:35"><decl pos:start="13:5" pos:end="13:34"><type pos:start="13:5" pos:end="13:11"><name pos:start="13:5" pos:end="13:11">uint8_t</name></type> <name pos:start="13:13" pos:end="13:34"><name pos:start="13:13" pos:end="13:18">bitmap</name><index pos:start="13:19" pos:end="13:34">[<expr pos:start="13:20" pos:end="13:33"><name pos:start="13:20" pos:end="13:33"><name pos:start="13:20" pos:end="13:20">s</name><operator pos:start="13:21" pos:end="13:22">-&gt;</operator><name pos:start="13:23" pos:end="13:33">bitmap_size</name></name></expr>]</index></name></decl>;</decl_stmt>



    <comment type="line" pos:start="17:5" pos:end="17:35">// Check if sector_num is valid</comment>

    <if_stmt pos:start="19:5" pos:end="21:18"><if pos:start="19:5" pos:end="21:18">if <condition pos:start="19:8" pos:end="19:61">(<expr pos:start="19:9" pos:end="19:60"><operator pos:start="19:9" pos:end="19:9">(</operator><name pos:start="19:10" pos:end="19:19">sector_num</name> <operator pos:start="19:21" pos:end="19:21">&lt;</operator> <literal type="number" pos:start="19:23" pos:end="19:23">0</literal><operator pos:start="19:24" pos:end="19:24">)</operator> <operator pos:start="19:26" pos:end="19:27">||</operator> <operator pos:start="19:29" pos:end="19:29">(</operator><name pos:start="19:30" pos:end="19:39">sector_num</name> <operator pos:start="19:41" pos:end="19:41">&gt;</operator> <name pos:start="19:43" pos:end="19:59"><name pos:start="19:43" pos:end="19:44">bs</name><operator pos:start="19:45" pos:end="19:46">-&gt;</operator><name pos:start="19:47" pos:end="19:59">total_sectors</name></name><operator pos:start="19:60" pos:end="19:60">)</operator></expr>)</condition><block type="pseudo" pos:start="21:9" pos:end="21:18"><block_content pos:start="21:9" pos:end="21:18">

        <return pos:start="21:9" pos:end="21:18">return <expr pos:start="21:16" pos:end="21:17"><operator pos:start="21:16" pos:end="21:16">-</operator><literal type="number" pos:start="21:17" pos:end="21:17">1</literal></expr>;</return></block_content></block></if></if_stmt>



    <comment type="line" pos:start="25:5" pos:end="25:37">// Write entry into in-memory BAT</comment>

    <expr_stmt pos:start="27:5" pos:end="27:47"><expr pos:start="27:5" pos:end="27:46"><name pos:start="27:5" pos:end="27:9">index</name> <operator pos:start="27:11" pos:end="27:11">=</operator> <operator pos:start="27:13" pos:end="27:13">(</operator><name pos:start="27:14" pos:end="27:23">sector_num</name> <operator pos:start="27:25" pos:end="27:25">*</operator> <literal type="number" pos:start="27:27" pos:end="27:29">512</literal><operator pos:start="27:30" pos:end="27:30">)</operator> <operator pos:start="27:32" pos:end="27:32">/</operator> <name pos:start="27:34" pos:end="27:46"><name pos:start="27:34" pos:end="27:34">s</name><operator pos:start="27:35" pos:end="27:36">-&gt;</operator><name pos:start="27:37" pos:end="27:46">block_size</name></name></expr>;</expr_stmt>

    <if_stmt pos:start="29:5" pos:end="31:18"><if pos:start="29:5" pos:end="31:18">if <condition pos:start="29:8" pos:end="29:42">(<expr pos:start="29:9" pos:end="29:41"><name pos:start="29:9" pos:end="29:27"><name pos:start="29:9" pos:end="29:9">s</name><operator pos:start="29:10" pos:end="29:11">-&gt;</operator><name pos:start="29:12" pos:end="29:20">pagetable</name><index pos:start="29:21" pos:end="29:27">[<expr pos:start="29:22" pos:end="29:26"><name pos:start="29:22" pos:end="29:26">index</name></expr>]</index></name> <operator pos:start="29:29" pos:end="29:30">!=</operator> <literal type="number" pos:start="29:32" pos:end="29:41">0xFFFFFFFF</literal></expr>)</condition><block type="pseudo" pos:start="31:9" pos:end="31:18"><block_content pos:start="31:9" pos:end="31:18">

        <return pos:start="31:9" pos:end="31:18">return <expr pos:start="31:16" pos:end="31:17"><operator pos:start="31:16" pos:end="31:16">-</operator><literal type="number" pos:start="31:17" pos:end="31:17">1</literal></expr>;</return></block_content></block></if></if_stmt>



    <expr_stmt pos:start="35:5" pos:end="35:58"><expr pos:start="35:5" pos:end="35:57"><name pos:start="35:5" pos:end="35:23"><name pos:start="35:5" pos:end="35:5">s</name><operator pos:start="35:6" pos:end="35:7">-&gt;</operator><name pos:start="35:8" pos:end="35:16">pagetable</name><index pos:start="35:17" pos:end="35:23">[<expr pos:start="35:18" pos:end="35:22"><name pos:start="35:18" pos:end="35:22">index</name></expr>]</index></name> <operator pos:start="35:25" pos:end="35:25">=</operator> <name pos:start="35:27" pos:end="35:51"><name pos:start="35:27" pos:end="35:27">s</name><operator pos:start="35:28" pos:end="35:29">-&gt;</operator><name pos:start="35:30" pos:end="35:51">free_data_block_offset</name></name> <operator pos:start="35:53" pos:end="35:53">/</operator> <literal type="number" pos:start="35:55" pos:end="35:57">512</literal></expr>;</expr_stmt>



    <comment type="line" pos:start="39:5" pos:end="39:36">// Initialize the block's bitmap</comment>

    <expr_stmt pos:start="41:5" pos:end="41:41"><expr pos:start="41:5" pos:end="41:40"><call pos:start="41:5" pos:end="41:40"><name pos:start="41:5" pos:end="41:10">memset</name><argument_list pos:start="41:11" pos:end="41:40">(<argument pos:start="41:12" pos:end="41:17"><expr pos:start="41:12" pos:end="41:17"><name pos:start="41:12" pos:end="41:17">bitmap</name></expr></argument>, <argument pos:start="41:20" pos:end="41:23"><expr pos:start="41:20" pos:end="41:23"><literal type="number" pos:start="41:20" pos:end="41:23">0xff</literal></expr></argument>, <argument pos:start="41:26" pos:end="41:39"><expr pos:start="41:26" pos:end="41:39"><name pos:start="41:26" pos:end="41:39"><name pos:start="41:26" pos:end="41:26">s</name><operator pos:start="41:27" pos:end="41:28">-&gt;</operator><name pos:start="41:29" pos:end="41:39">bitmap_size</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <expr_stmt pos:start="43:5" pos:end="43:77"><expr pos:start="43:5" pos:end="43:76"><call pos:start="43:5" pos:end="43:76"><name pos:start="43:5" pos:end="43:15">bdrv_pwrite</name><argument_list pos:start="43:16" pos:end="43:76">(<argument pos:start="43:17" pos:end="43:24"><expr pos:start="43:17" pos:end="43:24"><name pos:start="43:17" pos:end="43:24"><name pos:start="43:17" pos:end="43:18">bs</name><operator pos:start="43:19" pos:end="43:20">-&gt;</operator><name pos:start="43:21" pos:end="43:24">file</name></name></expr></argument>, <argument pos:start="43:27" pos:end="43:51"><expr pos:start="43:27" pos:end="43:51"><name pos:start="43:27" pos:end="43:51"><name pos:start="43:27" pos:end="43:27">s</name><operator pos:start="43:28" pos:end="43:29">-&gt;</operator><name pos:start="43:30" pos:end="43:51">free_data_block_offset</name></name></expr></argument>, <argument pos:start="43:54" pos:end="43:59"><expr pos:start="43:54" pos:end="43:59"><name pos:start="43:54" pos:end="43:59">bitmap</name></expr></argument>, <argument pos:start="43:62" pos:end="43:75"><expr pos:start="43:62" pos:end="43:75"><name pos:start="43:62" pos:end="43:75"><name pos:start="43:62" pos:end="43:62">s</name><operator pos:start="43:63" pos:end="43:64">-&gt;</operator><name pos:start="43:65" pos:end="43:75">bitmap_size</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>



    <comment type="line" pos:start="47:5" pos:end="47:57">// Write new footer (the old one will be overwritten)</comment>

    <expr_stmt pos:start="49:5" pos:end="49:64"><expr pos:start="49:5" pos:end="49:63"><name pos:start="49:5" pos:end="49:29"><name pos:start="49:5" pos:end="49:5">s</name><operator pos:start="49:6" pos:end="49:7">-&gt;</operator><name pos:start="49:8" pos:end="49:29">free_data_block_offset</name></name> <operator pos:start="49:31" pos:end="49:32">+=</operator> <name pos:start="49:34" pos:end="49:46"><name pos:start="49:34" pos:end="49:34">s</name><operator pos:start="49:35" pos:end="49:36">-&gt;</operator><name pos:start="49:37" pos:end="49:46">block_size</name></name> <operator pos:start="49:48" pos:end="49:48">+</operator> <name pos:start="49:50" pos:end="49:63"><name pos:start="49:50" pos:end="49:50">s</name><operator pos:start="49:51" pos:end="49:52">-&gt;</operator><name pos:start="49:53" pos:end="49:63">bitmap_size</name></name></expr>;</expr_stmt>

    <expr_stmt pos:start="51:5" pos:end="51:29"><expr pos:start="51:5" pos:end="51:28"><name pos:start="51:5" pos:end="51:7">ret</name> <operator pos:start="51:9" pos:end="51:9">=</operator> <call pos:start="51:11" pos:end="51:28"><name pos:start="51:11" pos:end="51:24">rewrite_footer</name><argument_list pos:start="51:25" pos:end="51:28">(<argument pos:start="51:26" pos:end="51:27"><expr pos:start="51:26" pos:end="51:27"><name pos:start="51:26" pos:end="51:27">bs</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <if_stmt pos:start="53:5" pos:end="55:18"><if pos:start="53:5" pos:end="55:18">if <condition pos:start="53:8" pos:end="53:16">(<expr pos:start="53:9" pos:end="53:15"><name pos:start="53:9" pos:end="53:11">ret</name> <operator pos:start="53:13" pos:end="53:13">&lt;</operator> <literal type="number" pos:start="53:15" pos:end="53:15">0</literal></expr>)</condition><block type="pseudo" pos:start="55:9" pos:end="55:18"><block_content pos:start="55:9" pos:end="55:18">

        <goto pos:start="55:9" pos:end="55:18">goto <name pos:start="55:14" pos:end="55:17">fail</name>;</goto></block_content></block></if></if_stmt>



    <comment type="line" pos:start="59:5" pos:end="59:30">// Write BAT entry to disk</comment>

    <expr_stmt pos:start="61:5" pos:end="61:45"><expr pos:start="61:5" pos:end="61:44"><name pos:start="61:5" pos:end="61:14">bat_offset</name> <operator pos:start="61:16" pos:end="61:16">=</operator> <name pos:start="61:18" pos:end="61:30"><name pos:start="61:18" pos:end="61:18">s</name><operator pos:start="61:19" pos:end="61:20">-&gt;</operator><name pos:start="61:21" pos:end="61:30">bat_offset</name></name> <operator pos:start="61:32" pos:end="61:32">+</operator> <operator pos:start="61:34" pos:end="61:34">(</operator><literal type="number" pos:start="61:35" pos:end="61:35">4</literal> <operator pos:start="61:37" pos:end="61:37">*</operator> <name pos:start="61:39" pos:end="61:43">index</name><operator pos:start="61:44" pos:end="61:44">)</operator></expr>;</expr_stmt>

    <expr_stmt pos:start="63:5" pos:end="63:49"><expr pos:start="63:5" pos:end="63:48"><name pos:start="63:5" pos:end="63:13">bat_value</name> <operator pos:start="63:15" pos:end="63:15">=</operator> <call pos:start="63:17" pos:end="63:48"><name pos:start="63:17" pos:end="63:27">be32_to_cpu</name><argument_list pos:start="63:28" pos:end="63:48">(<argument pos:start="63:29" pos:end="63:47"><expr pos:start="63:29" pos:end="63:47"><name pos:start="63:29" pos:end="63:47"><name pos:start="63:29" pos:end="63:29">s</name><operator pos:start="63:30" pos:end="63:31">-&gt;</operator><name pos:start="63:32" pos:end="63:40">pagetable</name><index pos:start="63:41" pos:end="63:47">[<expr pos:start="63:42" pos:end="63:46"><name pos:start="63:42" pos:end="63:46">index</name></expr>]</index></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <expr_stmt pos:start="65:5" pos:end="65:59"><expr pos:start="65:5" pos:end="65:58"><name pos:start="65:5" pos:end="65:7">ret</name> <operator pos:start="65:9" pos:end="65:9">=</operator> <call pos:start="65:11" pos:end="65:58"><name pos:start="65:11" pos:end="65:21">bdrv_pwrite</name><argument_list pos:start="65:22" pos:end="65:58">(<argument pos:start="65:23" pos:end="65:30"><expr pos:start="65:23" pos:end="65:30"><name pos:start="65:23" pos:end="65:30"><name pos:start="65:23" pos:end="65:24">bs</name><operator pos:start="65:25" pos:end="65:26">-&gt;</operator><name pos:start="65:27" pos:end="65:30">file</name></name></expr></argument>, <argument pos:start="65:33" pos:end="65:42"><expr pos:start="65:33" pos:end="65:42"><name pos:start="65:33" pos:end="65:42">bat_offset</name></expr></argument>, <argument pos:start="65:45" pos:end="65:54"><expr pos:start="65:45" pos:end="65:54"><operator pos:start="65:45" pos:end="65:45">&amp;</operator><name pos:start="65:46" pos:end="65:54">bat_value</name></expr></argument>, <argument pos:start="65:57" pos:end="65:57"><expr pos:start="65:57" pos:end="65:57"><literal type="number" pos:start="65:57" pos:end="65:57">4</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <if_stmt pos:start="67:5" pos:end="69:18"><if pos:start="67:5" pos:end="69:18">if <condition pos:start="67:8" pos:end="67:16">(<expr pos:start="67:9" pos:end="67:15"><name pos:start="67:9" pos:end="67:11">ret</name> <operator pos:start="67:13" pos:end="67:13">&lt;</operator> <literal type="number" pos:start="67:15" pos:end="67:15">0</literal></expr>)</condition><block type="pseudo" pos:start="69:9" pos:end="69:18"><block_content pos:start="69:9" pos:end="69:18">

        <goto pos:start="69:9" pos:end="69:18">goto <name pos:start="69:14" pos:end="69:17">fail</name>;</goto></block_content></block></if></if_stmt>



    <return pos:start="73:5" pos:end="73:48">return <expr pos:start="73:12" pos:end="73:47"><call pos:start="73:12" pos:end="73:47"><name pos:start="73:12" pos:end="73:28">get_sector_offset</name><argument_list pos:start="73:29" pos:end="73:47">(<argument pos:start="73:30" pos:end="73:31"><expr pos:start="73:30" pos:end="73:31"><name pos:start="73:30" pos:end="73:31">bs</name></expr></argument>, <argument pos:start="73:34" pos:end="73:43"><expr pos:start="73:34" pos:end="73:43"><name pos:start="73:34" pos:end="73:43">sector_num</name></expr></argument>, <argument pos:start="73:46" pos:end="73:46"><expr pos:start="73:46" pos:end="73:46"><literal type="number" pos:start="73:46" pos:end="73:46">0</literal></expr></argument>)</argument_list></call></expr>;</return>



<label pos:start="77:1" pos:end="77:5"><name pos:start="77:1" pos:end="77:4">fail</name>:</label>

    <expr_stmt pos:start="79:5" pos:end="79:66"><expr pos:start="79:5" pos:end="79:65"><name pos:start="79:5" pos:end="79:29"><name pos:start="79:5" pos:end="79:5">s</name><operator pos:start="79:6" pos:end="79:7">-&gt;</operator><name pos:start="79:8" pos:end="79:29">free_data_block_offset</name></name> <operator pos:start="79:31" pos:end="79:32">-=</operator> <operator pos:start="79:34" pos:end="79:34">(</operator><name pos:start="79:35" pos:end="79:47"><name pos:start="79:35" pos:end="79:35">s</name><operator pos:start="79:36" pos:end="79:37">-&gt;</operator><name pos:start="79:38" pos:end="79:47">block_size</name></name> <operator pos:start="79:49" pos:end="79:49">+</operator> <name pos:start="79:51" pos:end="79:64"><name pos:start="79:51" pos:end="79:51">s</name><operator pos:start="79:52" pos:end="79:53">-&gt;</operator><name pos:start="79:54" pos:end="79:64">bitmap_size</name></name><operator pos:start="79:65" pos:end="79:65">)</operator></expr>;</expr_stmt>

    <return pos:start="81:5" pos:end="81:14">return <expr pos:start="81:12" pos:end="81:13"><operator pos:start="81:12" pos:end="81:12">-</operator><literal type="number" pos:start="81:13" pos:end="81:13">1</literal></expr>;</return>

</block_content>}</block></function>
</unit>
